<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TabTriage</title>
<style>
:root {
    --bg: #f1f5f9; --card: #fff; --border: #e2e8f0;
    --text: #1e293b; --muted: #64748b; --light: #94a3b8;
    --blue: #3b82f6; --green: #22c55e; --amber: #f59e0b;
    --red: #ef4444; --purple: #8b5cf6; --indigo: #6366f1;
    --radius: 8px;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);font-size:14px}

/* Header */
.hdr{background:linear-gradient(135deg,#1e40af,#7c3aed);color:#fff;padding:16px 24px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px}
.hdr h1{font-size:20px;font-weight:700}
.hdr-stats{font-size:12px;opacity:.85}
.hdr-actions{display:flex;gap:6px;flex-wrap:wrap}
.hdr-btn{padding:6px 14px;border-radius:7px;border:1px solid rgba(255,255,255,.3);background:rgba(255,255,255,.15);color:#fff;font-size:12px;cursor:pointer;font-weight:500;white-space:nowrap}
.hdr-btn:hover{background:rgba(255,255,255,.25)}
.hdr-btn.danger{border-color:rgba(239,68,68,.5);background:rgba(239,68,68,.2)}
.hdr-btn.primary{background:rgba(255,255,255,.25);border-color:rgba(255,255,255,.5)}

/* Tabs nav */
.tabs-nav{display:flex;background:#fff;border-bottom:1px solid var(--border);padding:0 24px;gap:0}
.tab-btn{padding:10px 18px;font-size:13px;cursor:pointer;border:none;background:none;color:var(--muted);border-bottom:2px solid transparent;font-weight:500}
.tab-btn:hover{color:var(--text)}
.tab-btn.active{color:var(--blue);border-bottom-color:var(--blue)}
.tab-btn .badge-count{background:var(--blue);color:#fff;font-size:10px;padding:1px 6px;border-radius:8px;margin-left:4px}

/* Toolbar */
.toolbar{padding:10px 24px;display:flex;gap:8px;align-items:center;background:#fff;border-bottom:1px solid var(--border);flex-wrap:wrap}
.search-box{flex:1;min-width:180px;position:relative}
.search-box input{width:100%;padding:7px 10px 7px 30px;border:1px solid var(--border);border-radius:7px;font-size:13px;outline:none}
.search-box input:focus{border-color:var(--blue);box-shadow:0 0 0 2px rgba(59,130,246,.1)}
.search-box::before{content:'';position:absolute;left:10px;top:10px;width:12px;height:12px;border:2px solid var(--light);border-radius:50%}
.chip{padding:4px 10px;border-radius:14px;font-size:11px;cursor:pointer;border:1px solid var(--border);background:#fff;transition:all .12s;white-space:nowrap;user-select:none}
.chip:hover{border-color:var(--blue);color:var(--blue)}
.chip.active{background:var(--blue);color:#fff;border-color:var(--blue)}
.chip.star{color:var(--amber)}.chip.star.active{background:var(--amber);border-color:var(--amber);color:#fff}
.sel-all{display:flex;align-items:center;gap:4px;font-size:11px;color:var(--muted)}
.sel-all input{width:15px;height:15px;cursor:pointer}

/* Bulk bar */
.bulk{display:none;padding:8px 24px;background:#eff6ff;border-bottom:1px solid #bfdbfe;align-items:center;gap:8px;flex-wrap:wrap}
.bulk.show{display:flex}
.bulk .cnt{font-weight:600;font-size:12px;color:var(--blue);min-width:70px}
.bulk select,.bulk input[type=text]{padding:5px 8px;border:1px solid #93c5fd;border-radius:5px;font-size:11px;background:#fff}
.bbtn{padding:5px 12px;border-radius:5px;font-size:11px;font-weight:600;cursor:pointer;border:none;color:#fff}

/* Container */
.container{max-width:1100px;margin:0 auto;padding:16px 24px 60px}

/* Cluster */
.cluster{margin-bottom:20px}
.cl-hdr{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:2px solid var(--border);margin-bottom:8px}
.cl-label{font-size:14px;font-weight:700}.cl-cnt{font-size:11px;color:var(--muted);background:var(--bg);padding:1px 7px;border-radius:8px}
.cl-proj{font-size:11px;color:var(--purple);font-weight:500}
.cl-actions{margin-left:auto}

/* Card */
.cards{display:flex;flex-direction:column;gap:5px}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:10px 12px;display:grid;grid-template-columns:26px 1fr;gap:0 8px;align-items:start;transition:all .15s;border-left:3px solid transparent;position:relative}
.card:hover{box-shadow:0 2px 8px rgba(0,0,0,.05)}
.card.cat-read-later{border-left-color:var(--blue)}.card.cat-reference{border-left-color:var(--purple)}
.card.cat-actionable{border-left-color:var(--amber)}.card.cat-archive{border-left-color:var(--light)}
.card.cat-dismiss{border-left-color:var(--red);opacity:.4}.card.selected{background:#eff6ff;border-color:var(--blue)}
.card.done{opacity:.35;transform:scale(.98);transition:all .4s}
.card.hiding{opacity:0;max-height:0;padding:0;margin:0;border:none;overflow:hidden;transition:all .4s}

.card-ck{grid-row:1/4;display:flex;flex-direction:column;align-items:center;gap:4px;padding-top:2px}
.card-ck input[type=checkbox]{width:15px;height:15px;cursor:pointer}
.star{background:none;border:none;cursor:pointer;font-size:15px;color:var(--border);padding:0;line-height:1}
.star.on{color:var(--amber)}

.card-main{min-width:0;cursor:pointer}
.card-top{display:flex;align-items:center;gap:6px;margin-bottom:2px}
.card-fav{width:14px;height:14px;border-radius:2px;flex-shrink:0}
.card-ttl{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
.card-ttl a{color:inherit;text-decoration:none}.card-ttl a:hover{color:var(--blue)}
.card-dom{font-size:10px;color:var(--light);white-space:nowrap}
.card-meta{font-size:9px;color:var(--light);display:flex;gap:8px;margin-top:1px}
.card-meta span{white-space:nowrap}
.card-tags{display:flex;gap:3px;flex-wrap:wrap;margin-left:auto}
.tag{font-size:9px;padding:1px 6px;border-radius:8px;background:#f1f5f9;color:var(--muted)}

.card-body{display:flex;gap:10px;margin-top:4px}
.card-thumb{width:72px;height:48px;border-radius:4px;object-fit:cover;flex-shrink:0;background:var(--bg)}
.card-info{flex:1;min-width:0}
.card-sum{font-size:12px;color:var(--muted);line-height:1.5;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;transition:all .3s}
.card-sum.expanded{-webkit-line-clamp:unset;color:var(--text)}
.card-sum.loading{color:var(--light);font-style:italic}

/* Controls row */
.card-ctrl{display:none;gap:5px;margin-top:6px;align-items:center;flex-wrap:wrap}
.card.open .card-ctrl{display:flex}
.card-ctrl select{padding:3px 5px;border:1px solid var(--border);border-radius:4px;font-size:11px;background:#fff;max-width:120px}
.ac-wrap{position:relative;display:inline-block}
.ac-input{padding:3px 5px;border:1px solid var(--border);border-radius:4px;font-size:11px;width:130px}
.ac-list{position:absolute;top:100%;left:0;background:#fff;border:1px solid var(--border);border-radius:6px;max-height:180px;overflow-y:auto;z-index:100;width:220px;box-shadow:0 4px 12px rgba(0,0,0,.12);display:none}
.ac-list.open{display:block}
.ac-item{padding:5px 8px;font-size:11px;cursor:pointer}
.ac-item:hover,.ac-item.hl{background:#eff6ff}
.mbtn{padding:3px 8px;border-radius:4px;font-size:11px;cursor:pointer;border:1px solid var(--border);background:#fff;white-space:nowrap}
.mbtn:hover{background:var(--bg)}
.mbtn.sv{color:var(--green);border-color:var(--green)}
.mbtn.sc{color:var(--indigo);border-color:var(--indigo)}
.mbtn.cl{color:var(--red);border-color:var(--red)}
.mbtn.td{color:var(--amber);border-color:var(--amber)}
.mbtn.dn{background:var(--green);color:#fff;border-color:var(--green);cursor:default}

/* Media */
.card-media{margin-top:6px;display:none}
.card.open .card-media{display:block}
.card-media video,.card-media audio{width:100%;max-width:400px;border-radius:6px}

/* Fulltext overlay */
.ft-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;justify-content:center;align-items:start;padding:30px 16px;overflow-y:auto}
.ft-overlay.open{display:flex}
.ft-panel{background:#fff;border-radius:12px;max-width:700px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.2);max-height:calc(100vh - 60px);overflow-y:auto}
.ft-hdr{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:#fff;z-index:1}
.ft-hdr h3{font-size:16px;font-weight:600;flex:1}
.ft-close{background:none;border:none;font-size:22px;cursor:pointer;color:var(--muted);padding:0 4px}
.ft-body{padding:20px;font-size:14px;line-height:1.8;white-space:pre-wrap;word-wrap:break-word;color:var(--text)}

/* Analytics */
.analytics{padding:24px;display:none}
.analytics.show{display:block}
.ana-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
.ana-card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:16px}
.ana-card h3{font-size:14px;font-weight:600;margin-bottom:10px;color:var(--muted)}
.ana-bar{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.ana-bar-label{font-size:12px;min-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ana-bar-fill{height:18px;border-radius:4px;background:var(--blue);min-width:2px;transition:width .3s}
.ana-bar-val{font-size:11px;color:var(--muted)}

/* Toast */
.toast{position:fixed;bottom:16px;right:16px;background:#1e293b;color:#fff;padding:10px 16px;border-radius:7px;font-size:13px;z-index:2000;opacity:0;transition:opacity .3s;max-width:350px}
.toast.show{opacity:1}
.empty{text-align:center;padding:40px 20px;color:var(--muted)}

/* Mobile */
@media(max-width:640px){
    .hdr{padding:12px 16px}.toolbar{padding:8px 16px}.container{padding:12px 16px 60px}
    .card{touch-action:pan-y;user-select:none}
    .card.swiping{transition:transform .1s}
    .card.swipe-right{transform:translateX(100px);opacity:.5}
    .card.swipe-left{transform:translateX(-100px);opacity:.5}
    .card-ctrl{display:flex !important;flex-wrap:wrap}
    .card-body{flex-direction:column}
    .card-thumb{width:100%;height:auto;max-height:120px}
    .ac-input{width:100px}
}
</style>
</head>
<body>

<div class="hdr">
    <div>
        <h1>TabTriage</h1>
        <div class="hdr-stats" id="stats"></div>
    </div>
    <div class="hdr-actions">
        <button class="hdr-btn primary" onclick="bulkSaveAll()">Alle speichern</button>
        <button class="hdr-btn" onclick="bulkSaveAndCloseAll()">Alle speichern & schliessen</button>
        <button class="hdr-btn danger" onclick="closeTriaged()">Gespeicherte Tabs schliessen</button>
    </div>
</div>

<div class="tabs-nav">
    <button class="tab-btn active" onclick="setView('triage')" data-view="triage">Triage <span class="badge-count" id="pendingCount">0</span></button>
    <button class="tab-btn" onclick="setView('archive')" data-view="archive">Archiv</button>
    <button class="tab-btn" onclick="setView('analytics')" data-view="analytics">Analyse</button>
</div>

<div class="toolbar" id="toolbar">
    <div class="search-box"><input type="text" id="searchInput" placeholder="Suchen..." oninput="render()"></div>
    <div class="chip active" onclick="setFilter('all')" data-filter="all">Alle</div>
    <div class="chip" onclick="setFilter('read-later')" data-filter="read-later">Lesen</div>
    <div class="chip" onclick="setFilter('reference')" data-filter="reference">Referenz</div>
    <div class="chip" onclick="setFilter('actionable')" data-filter="actionable">Aktion</div>
    <div class="chip star" onclick="setFilter('starred')" data-filter="starred">&#9733;</div>
    <div class="sel-all"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"><span>Alle</span></div>
</div>

<div class="bulk" id="bulkBar">
    <span class="cnt" id="bulkCount">0</span>
    <select id="bulkCat"><option value="">Kategorie</option><option value="read-later">Lesen</option><option value="reference">Referenz</option><option value="actionable">Aktion</option><option value="archive">Archiv</option></select>
    <select id="bulkNotion"><option value="">Notion</option><option value="links">Links-DB</option><option value="parken">Backlog</option><option value="todo-today">Todo Heute</option><option value="todo-someday">Todo Irgendwann</option></select>
    <div class="ac-wrap"><input class="ac-input" id="bulkProj" placeholder="Projekt..." oninput="acShow(this,'bulkPL')" onfocus="acShow(this,'bulkPL')"><div class="ac-list" id="bulkPL"></div></div>
    <button class="bbtn" style="background:var(--blue)" onclick="bulkSave()">Speichern</button>
    <button class="bbtn" style="background:var(--green)" onclick="bulkSave(true)">Speichern & schliessen</button>
    <button class="bbtn" style="background:var(--red)" onclick="bulkDismiss()">Verwerfen</button>
</div>

<div class="container" id="content"></div>
<div class="analytics" id="analyticsView"></div>

<div class="ft-overlay" id="ftOverlay" onclick="if(event.target===this)closeFt()">
    <div class="ft-panel">
        <div class="ft-hdr"><h3 id="ftTitle"></h3><button class="ft-close" onclick="closeFt()">&times;</button></div>
        <div class="ft-body" id="ftBody"></div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
const B = 'http://localhost:5111';
const SD = /*DATA_PLACEHOLDER*/[];
let filter = 'all', view = 'triage', projects = [], sel = new Set(), bpid = '', openCards = new Set();

fetch(B+'/api/notion/projects').then(r=>r.json()).then(p=>{projects=p}).catch(()=>{});

function esc(s){return s?String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'):''}
function dom(u){try{return new URL(u).hostname.replace('www.','')}catch(e){return u}}
function fmtDate(s){if(!s)return'';try{const d=new Date(s.replace(' ','T')+'Z');return d.toLocaleDateString('de-DE',{day:'2-digit',month:'2-digit',year:'2-digit'})+' '+d.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'})}catch(e){return s.substring(0,16)}}

function allTabs(){let t=[];for(const s of SD)for(const x of s.tabs){x._s=s.session;t.push(x)}return t}

function filtered(showArchive){
    const q=document.getElementById('searchInput').value.toLowerCase();
    let t=allTabs();
    if(!showArchive){
        t=t.filter(x=>{
            if(filter==='starred')return x.starred&&!x.triaged_at;
            if(filter!=='all')return(x.category||x.suggested_category)===filter&&!x.triaged_at;
            return !x.triaged_at;
        });
    } else {
        t=t.filter(x=>x.triaged_at);
    }
    if(q)t=t.filter(x=>[x.title,x.summary,x.url,x.user_note,x.cluster_label,...(x.tags||[])].some(v=>(v||'').toLowerCase().includes(q)));
    return t;
}

function setView(v){
    view=v;
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.toggle('active',b.dataset.view===v));
    document.getElementById('toolbar').style.display=v==='analytics'?'none':'flex';
    document.getElementById('content').style.display=v==='analytics'?'none':'block';
    document.getElementById('analyticsView').classList.toggle('show',v==='analytics');
    if(v==='analytics')renderAnalytics();
    else render();
}

function setFilter(f){
    filter=f;
    document.querySelectorAll('.chip').forEach(c=>c.classList.toggle('active',c.dataset.filter===f));
    render();
}

function render(){
    const all=allTabs(), tabs=filtered(view==='archive');
    const pending=all.filter(x=>!x.triaged_at).length;
    const starred=all.filter(x=>x.starred).length;
    document.getElementById('stats').textContent=`${all.length} Tabs | ${all.length-pending} gespeichert | ${pending} offen | ${starred} gemerkt`;
    document.getElementById('pendingCount').textContent=pending;

    if(!tabs.length){document.getElementById('content').innerHTML='<div class="empty">Keine Tabs.</div>';updateBulk();return}

    // Group by cluster
    const clusters={},other=[];
    for(const t of tabs){
        if(t.cluster_id&&t.cluster_label){
            if(!clusters[t.cluster_id])clusters[t.cluster_id]={label:t.cluster_label,tabs:[],pid:null};
            clusters[t.cluster_id].tabs.push(t);
            if(t.project_id&&!clusters[t.cluster_id].pid)clusters[t.cluster_id].pid=t.project_id;
        }else other.push(t);
    }

    let h='';
    for(const[cid,cl]of Object.entries(clusters).sort((a,b)=>b[1].tabs.length-a[1].tabs.length)){
        const pn=cl.pid?(projects.find(p=>p.id===cl.pid)||{}).name||'':'';
        h+=`<div class="cluster"><div class="cl-hdr"><span class="cl-label">${esc(cl.label)}</span><span class="cl-cnt">${cl.tabs.length}</span>${pn?`<span class="cl-proj">${esc(pn)}</span>`:''}<div class="cl-actions"><button class="mbtn" onclick="selCluster('${esc(cid)}')">Alle wählen</button></div></div><div class="cards">${cl.tabs.map(cardH).join('')}</div></div>`;
    }
    if(other.length)h+=`<div class="cluster"><div class="cl-hdr"><span class="cl-label">Weitere</span><span class="cl-cnt">${other.length}</span></div><div class="cards">${other.map(cardH).join('')}</div></div>`;

    document.getElementById('content').innerHTML=h;
    updateBulk();
    initSwipe();
}

function cardH(t){
    const cat=t.category||t.suggested_category||'pending';
    const o=openCards.has(t.id)?'open':'';
    const s=sel.has(t.id)?'selected':'';
    const d=t.triaged_at&&view!=='archive'?'done':'';
    const fav=t.favicon?`<img class="card-fav" src="${esc(t.favicon)}" onerror="this.style.display='none'">`:'';
    const thumb=t.og_image?`<img class="card-thumb" src="${esc(t.og_image)}" onerror="this.style.display='none'">`:'';
    const pn=t.project_id?(projects.find(p=>p.id===t.project_id)||{}).name||'':'';
    const tags=(t.tags||[]).map(g=>`<span class="tag">${esc(g)}</span>`).join('');
    const media=t.media&&t.media.length?t.media.map(m=>{
        if(m.type==='video')return`<video controls preload="none"${m.poster?' poster="'+esc(m.poster)+'"':''}><source src="${esc(m.src)}"></video>`;
        if(m.type==='audio')return`<audio controls preload="none"><source src="${esc(m.src)}"></audio>`;
        if(m.type==='embed')return`<iframe src="${esc(m.src)}" style="width:100%;height:200px;border:none;border-radius:6px" allowfullscreen></iframe>`;
        return'';
    }).join(''):'';

    return`<div class="card cat-${cat} ${s} ${d} ${o}" id="c${t.id}" data-id="${t.id}">
<div class="card-ck"><input type="checkbox" ${sel.has(t.id)?'checked':''} onchange="togSel(${t.id})" onclick="event.stopPropagation()"><button class="star ${t.starred?'on':''}" onclick="togStar(${t.id});event.stopPropagation()">&#9733;</button></div>
<div class="card-main" onclick="togOpen(${t.id})">
<div class="card-top">${fav}<span class="card-ttl"><a href="${esc(t.url)}" target="_blank" onclick="event.stopPropagation()">${esc(t.title)}</a></span><span class="card-dom">${esc(dom(t.url))}</span>${tags?`<div class="card-tags">${tags}</div>`:''}</div>
<div class="card-meta"><span>${fmtDate(t.captured_at)}</span>${t._s&&t._s.hostname?`<span>${esc(t._s.hostname)}</span>`:''}</div>
<div class="card-body">${thumb?'<div>'+thumb+'</div>':''}<div class="card-info"><div class="card-sum ${t.summary?'':'loading'} ${o?'expanded':''}">${esc(t.summary||'Wird zusammengefasst...')}</div></div></div>
<div class="card-ctrl" onclick="event.stopPropagation()">
<select onchange="setF(${t.id},'_cat',this.value)"><option value="">Kategorie</option><option value="read-later" ${cat==='read-later'?'selected':''}>Lesen</option><option value="reference" ${cat==='reference'?'selected':''}>Referenz</option><option value="actionable" ${cat==='actionable'?'selected':''}>Aktion</option><option value="archive" ${cat==='archive'?'selected':''}>Archiv</option></select>
<div class="ac-wrap"><input class="ac-input" value="${esc(pn)}" placeholder="Projekt..." data-tid="${t.id}" oninput="acShow(this,'al${t.id}')" onfocus="acShow(this,'al${t.id}')" onclick="event.stopPropagation()"><div class="ac-list" id="al${t.id}"></div></div>
<select onchange="setF(${t.id},'_notion',this.value)"><option value="">Notion</option><option value="links">Links-DB</option><option value="parken">Backlog</option><option value="project">Projekt</option><option value="todo-today">Todo Heute</option><option value="todo-someday">Todo Irgendwann</option></select>
${t.has_content?`<button class="mbtn" onclick="openFt(${t.id})">Volltext</button>`:''}
<button class="mbtn sv" onclick="save1(${t.id})">Speichern</button>
<button class="mbtn sc" onclick="save1(${t.id},true)">Speichern & schliessen</button>
<button class="mbtn cl" onclick="dismiss1(${t.id})">Verwerfen</button>
<button class="mbtn" onclick="closeTab(${t.id})">Nur schliessen</button>
${t.triaged_at?'<span class="mbtn dn">&#10003;</span>':''}
</div>
${media?`<div class="card-media">${media}</div>`:''}
</div></div>`;
}

// Toggle card open/close
function togOpen(id){
    if(openCards.has(id))openCards.delete(id);else openCards.add(id);
    const el=document.getElementById('c'+id);
    if(el)el.classList.toggle('open');
    const sum=el?.querySelector('.card-sum');
    if(sum)sum.classList.toggle('expanded');
}

function setF(id,f,v){const t=allTabs().find(x=>x.id===id);if(t)t[f]=v}
function togSel(id){sel.has(id)?sel.delete(id):sel.add(id);document.getElementById('c'+id)?.classList.toggle('selected');updateBulk()}
function toggleSelectAll(){const c=document.getElementById('selectAll').checked;const f=filtered(view==='archive');if(c)f.forEach(t=>sel.add(t.id));else sel.clear();render()}
function selCluster(cid){allTabs().filter(t=>t.cluster_id===cid&&!t.triaged_at).forEach(t=>sel.add(t.id));render()}
function updateBulk(){const b=document.getElementById('bulkBar');b.classList.toggle('show',sel.size>0);document.getElementById('bulkCount').textContent=sel.size+' gewählt'}

async function togStar(id){
    const t=allTabs().find(x=>x.id===id);if(!t)return;
    t.starred=t.starred?0:1;
    fetch(B+'/api/tabs/'+id+'/star',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tab_id:id,starred:!!t.starred})}).catch(()=>{});
    const btn=document.querySelector(`#c${id} .star`);
    if(btn)btn.classList.toggle('on');
}

function getState(t){return{tab_id:t.id,category:t._cat||t.category||t.suggested_category||'read-later',project_id:t._pid||t.project_id||null,notion_target:t._notion||null}}

async function save1(id,close){
    const t=allTabs().find(x=>x.id===id);if(!t)return;
    const s=getState(t);
    try{
        const r=await fetch(B+'/api/triage',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(s)});
        await r.json();
        t.category=s.category;t.project_id=s.project_id;t.triaged_at=new Date().toISOString();
        if(close){await fetch(B+'/api/tabs/'+id+'/request-close',{method:'POST'})}
        const el=document.getElementById('c'+id);
        if(el){el.classList.add('done');setTimeout(()=>{el.classList.add('hiding');setTimeout(()=>render(),400)},300)}
        showToast(close?'Gespeichert + Tab wird geschlossen':'Gespeichert');
    }catch(e){showToast('Fehler: '+e.message)}
}

async function dismiss1(id){
    const t=allTabs().find(x=>x.id===id);if(!t)return;
    try{
        await fetch(B+'/api/triage',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tab_id:id,category:'dismiss'})});
        await fetch(B+'/api/tabs/'+id+'/request-close',{method:'POST'});
        t.category='dismiss';t.triaged_at=new Date().toISOString();
        const el=document.getElementById('c'+id);
        if(el){el.classList.add('done');setTimeout(()=>{el.classList.add('hiding');setTimeout(()=>render(),400)},300)}
        showToast('Verworfen + Tab geschlossen');
    }catch(e){showToast('Fehler: '+e.message)}
}

async function closeTab(id){
    await fetch(B+'/api/tabs/'+id+'/request-close',{method:'POST'});
    const el=document.getElementById('c'+id);
    if(el){el.classList.add('hiding');setTimeout(()=>render(),400)}
    showToast('Tab wird geschlossen');
}

async function bulkSave(close){
    const cat=document.getElementById('bulkCat').value;
    const notion=document.getElementById('bulkNotion').value;
    const items=[];
    for(const id of sel){
        const t=allTabs().find(x=>x.id===id);if(!t)continue;
        items.push({tab_id:id,category:t._cat||cat||t.suggested_category||'read-later',project_id:t._pid||bpid||t.project_id||null,notion_target:t._notion||notion||null});
    }
    if(!items.length)return;
    showToast(`Speichere ${items.length}...`);
    try{
        await fetch(B+'/api/triage/bulk',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({items})});
        if(close){
            const ids=items.map(i=>i.tab_id);
            await fetch(B+'/api/tabs/request-close-bulk',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tab_ids:ids})});
        }
        for(const i of items){const t=allTabs().find(x=>x.id===i.tab_id);if(t){t.category=i.category;t.project_id=i.project_id;t.triaged_at=new Date().toISOString()}}
        sel.clear();showToast(`${items.length} gespeichert!`);render();
    }catch(e){showToast('Fehler: '+e.message)}
}

async function bulkDismiss(){
    const items=Array.from(sel).map(id=>({tab_id:id,category:'dismiss'}));
    const ids=Array.from(sel);
    try{
        await fetch(B+'/api/triage/bulk',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({items})});
        await fetch(B+'/api/tabs/request-close-bulk',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tab_ids:ids})});
        for(const i of items){const t=allTabs().find(x=>x.id===i.tab_id);if(t){t.category='dismiss';t.triaged_at=new Date().toISOString()}}
        sel.clear();showToast(`${items.length} verworfen + Tabs geschlossen`);render();
    }catch(e){showToast('Fehler: '+e.message)}
}

async function bulkSaveAll(){
    const tabs=filtered(false);if(!tabs.length){showToast('Keine offenen Tabs');return}
    const items=tabs.map(t=>({tab_id:t.id,category:t._cat||t.category||t.suggested_category||'read-later',project_id:t._pid||t.project_id||null,notion_target:t._notion||null}));
    showToast(`Speichere ${items.length}...`);
    try{
        await fetch(B+'/api/triage/bulk',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({items})});
        for(const i of items){const t=allTabs().find(x=>x.id===i.tab_id);if(t){t.category=i.category;t.triaged_at=new Date().toISOString()}}
        showToast(`${items.length} gespeichert!`);render();
    }catch(e){showToast('Fehler: '+e.message)}
}

async function bulkSaveAndCloseAll(){await bulkSaveAll();await closeTriaged()}

async function closeTriaged(){
    const triaged=allTabs().filter(t=>t.triaged_at);
    if(!triaged.length){showToast('Keine gespeicherten Tabs');return}
    const ids=triaged.map(t=>t.id);
    try{
        await fetch(B+'/api/tabs/request-close-bulk',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tab_ids:ids})});
        showToast(`${ids.length} Tabs werden geschlossen`);
    }catch(e){showToast('Fehler: '+e.message)}
}

// Fulltext overlay
async function openFt(id){
    const t=allTabs().find(x=>x.id===id);
    document.getElementById('ftTitle').textContent=t?t.title:'';
    document.getElementById('ftBody').textContent='Lade...';
    document.getElementById('ftOverlay').classList.add('open');
    try{
        const r=await fetch(B+'/api/tabs/'+id+'/content');
        const d=await r.json();
        document.getElementById('ftBody').textContent=d.content||'[Kein Inhalt]';
    }catch(e){document.getElementById('ftBody').textContent='Fehler: '+e.message}
}
function closeFt(){document.getElementById('ftOverlay').classList.remove('open')}

// Autocomplete
function acShow(inp,lid){
    const l=document.getElementById(lid);
    const q=inp.value.toLowerCase();
    const m=projects.filter(p=>p.name.toLowerCase().includes(q)).slice(0,12);
    if(!m.length){l.classList.remove('open');return}
    l.innerHTML=m.map(p=>`<div class="ac-item" onmousedown="acPick('${esc(p.id)}','${esc(p.name)}','${lid}')">${esc(p.name)}</div>`).join('');
    l.classList.add('open');
}
function acPick(id,name,lid){
    const l=document.getElementById(lid);
    const inp=l.parentElement.querySelector('input');
    inp.value=name;l.classList.remove('open');
    if(lid==='bulkPL'){bpid=id}else{
        const tid=parseInt(inp.dataset.tid);
        const t=allTabs().find(x=>x.id===tid);if(t)t._pid=id;
    }
}
document.addEventListener('click',e=>{if(!e.target.closest('.ac-wrap'))document.querySelectorAll('.ac-list').forEach(l=>l.classList.remove('open'))});

// Mobile swipe
function initSwipe(){
    if(window.innerWidth>640)return;
    document.querySelectorAll('.card').forEach(card=>{
        let sx=0,dx=0;
        card.addEventListener('touchstart',e=>{sx=e.touches[0].clientX;dx=0;card.classList.add('swiping')},{passive:true});
        card.addEventListener('touchmove',e=>{dx=e.touches[0].clientX-sx;if(Math.abs(dx)>10){card.style.transform=`translateX(${dx}px)`;card.style.opacity=1-Math.abs(dx)/300}},{passive:true});
        card.addEventListener('touchend',()=>{
            card.classList.remove('swiping');
            const id=parseInt(card.dataset.id);
            if(dx>80){save1(id,true);} // swipe right = save & close
            else if(dx<-80){dismiss1(id);} // swipe left = dismiss
            else{card.style.transform='';card.style.opacity=''}
        },{passive:true});
    });
}

// Analytics
function renderAnalytics(){
    const tabs=allTabs();
    // Sources
    const sources={};tabs.forEach(t=>{const d=dom(t.url);sources[d]=(sources[d]||0)+1});
    const srcSorted=Object.entries(sources).sort((a,b)=>b[1]-a[1]).slice(0,15);
    const srcMax=srcSorted[0]?srcSorted[0][1]:1;

    // Tags
    const tagCounts={};tabs.forEach(t=>(t.tags||[]).forEach(g=>{tagCounts[g]=(tagCounts[g]||0)+1}));
    const tagSorted=Object.entries(tagCounts).sort((a,b)=>b[1]-a[1]).slice(0,20);
    const tagMax=tagSorted[0]?tagSorted[0][1]:1;

    // Categories
    const cats={};tabs.forEach(t=>{const c=t.category||t.suggested_category||'pending';cats[c]=(cats[c]||0)+1});

    // Clusters
    const clust={};tabs.forEach(t=>{if(t.cluster_label){clust[t.cluster_label]=(clust[t.cluster_label]||0)+1}});
    const clustSorted=Object.entries(clust).sort((a,b)=>b[1]-a[1]);

    // Dates
    const dates={};tabs.forEach(t=>{const d=(t.captured_at||'').substring(0,10);if(d)dates[d]=(dates[d]||0)+1});

    let h=`<div class="ana-grid">`;

    h+=`<div class="ana-card"><h3>Quellen (${Object.keys(sources).length})</h3>${srcSorted.map(([d,n])=>`<div class="ana-bar"><span class="ana-bar-label">${esc(d)}</span><div class="ana-bar-fill" style="width:${n/srcMax*100}%"></div><span class="ana-bar-val">${n}</span></div>`).join('')}</div>`;

    h+=`<div class="ana-card"><h3>Tags (${Object.keys(tagCounts).length})</h3>${tagSorted.map(([g,n])=>`<div class="ana-bar"><span class="ana-bar-label">${esc(g)}</span><div class="ana-bar-fill" style="width:${n/tagMax*100}%;background:var(--purple)"></div><span class="ana-bar-val">${n}</span></div>`).join('')}</div>`;

    h+=`<div class="ana-card"><h3>Kategorien</h3>${Object.entries(cats).map(([c,n])=>`<div class="ana-bar"><span class="ana-bar-label">${esc(c)}</span><div class="ana-bar-fill" style="width:${n/tabs.length*100}%;background:var(--amber)"></div><span class="ana-bar-val">${n}</span></div>`).join('')}</div>`;

    h+=`<div class="ana-card"><h3>Themen-Cluster</h3>${clustSorted.map(([c,n])=>`<div class="ana-bar"><span class="ana-bar-label">${esc(c)}</span><div class="ana-bar-fill" style="width:${n/tabs.length*100}%;background:var(--green)"></div><span class="ana-bar-val">${n}</span></div>`).join('')}</div>`;

    h+=`<div class="ana-card"><h3>Zeitverlauf</h3>${Object.entries(dates).sort().reverse().map(([d,n])=>`<div class="ana-bar"><span class="ana-bar-label">${d}</span><div class="ana-bar-fill" style="width:${n/Math.max(...Object.values(dates))*100}%;background:var(--indigo)"></div><span class="ana-bar-val">${n}</span></div>`).join('')}</div>`;

    h+=`<div class="ana-card"><h3>Zusammenfassung</h3><div style="font-size:12px;line-height:1.8;color:var(--muted)"><p><b>${tabs.length}</b> Tabs insgesamt</p><p><b>${tabs.filter(t=>t.triaged_at).length}</b> triaged</p><p><b>${tabs.filter(t=>t.starred).length}</b> gemerkt</p><p><b>${Object.keys(tagCounts).length}</b> verschiedene Tags</p><p><b>${Object.keys(sources).length}</b> verschiedene Quellen</p></div></div>`;

    h+=`</div>`;
    document.getElementById('analyticsView').innerHTML=h;
}

function showToast(m){const e=document.getElementById('toast');e.textContent=m;e.classList.add('show');setTimeout(()=>e.classList.remove('show'),3000)}

document.addEventListener('keydown',e=>{
    if(e.key==='/'&&!e.target.matches('input,textarea,select')){e.preventDefault();document.getElementById('searchInput').focus()}
    if(e.key==='Escape')closeFt();
});

render();
</script>
</body>
</html>
